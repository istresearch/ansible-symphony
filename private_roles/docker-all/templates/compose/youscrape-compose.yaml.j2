version: '2'

services:

  youscrape:
    image: istresearch/youscrape:{{ youscrape_scraper_tag }}
    environment:
     - GOOGLE_APPLICATION_CREDENTIALS=/usr/src/app/YouScrape.json
     - API_KEY={{ youscrape_api_key }}
     - YOUTUBE_THROTTLE_TIME=3
     - REDIS_Q_SLEEP_TIME=5
     - REDIS_QUEUE_NEW={{ youscrape_queue_new }}
     - REDIS_QUEUE_USERS={{ youscrape_queue_users }}
     - REDIS_QUEUE_USERS_MAX_LIMIT=1000
     - REDIS_QUEUE_VIDEOS={{ youscrape_queue_videos }}
     - REDIS_QUEUE_VIDEOS_MAX_LIMIT=200
     - REDIS_HOST={{ youscrape_redis_host }}
     - REDIS_PORT=6379
     - REDIS_DB={{ youscrape_redis_db }}
      #current min for comments is 100 per video
     - COMMENT_MAX_LIMIT=1000
     - KAFKA_HOSTS={% for host in groups['kafka-nodes'] %}{{ host }}:{{ kafka_port|default(9092) }}{% if not loop.last %},{% endif %}{% endfor %}
     - KAFKA_TOPIC={{ youscrape_kafka_topic_prefix|default('crawl') }}.{{ youscrape_kafka_topic_main|default('incoming') }}
     - LOGGER_NAME=youscrape
     - LOG_DIR=/var/log/youscrape
     - LOG_FILE=youscrape.log
     - LOG_STDOUT=False
     - LOG_JSON=True
     - LOG_LEVEL=INFO
    restart: always
    volumes:
     - logs:/var/log/youscrape
      # Get the JSON creds from the YouTube App Dashboard
     - {{ docker_configs_dir }}/YouScrape-creds.{{ youscrape_acct_phone }}.json:/usr/src/app/YouScrape.json

  logstash:
    image: logstash:{{ logstash_tag }}
    command: logstash -f /etc/logstash/conf.d/logstash.conf
    volumes:
      - {{ docker_configs_dir }}/{{ logstash_file_final }}:/etc/logstash/conf.d/logstash.conf
      - {{ docker_configs_dir }}/logs-template.{{ deploy_env }}.json:/etc/logstash/templates/logs-template.json
      - logs:/var/log/container-logs
    restart: "on-failure:3"

volumes:
  logs:
