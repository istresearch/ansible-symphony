---
# file: roles/dd-agent/tasks/main.yml
# dd-agent install: https://app.datadoghq.com/account/settings#agent/ubuntu

- name: Install dependencies for dd-agent
  apt:
    name: apt-transport-https
    state: present
    update_cache: yes

- name: Add dd-agent repository to source list
  apt_repository:
    repo: 'deb http://apt.datadoghq.com/ stable main'
    state: present

- name: Import dd-agent apt key
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: C7A7DA52

- name: Install dd-agent
  apt:
    name: datadog-agent
    state: present
    update_cache: yes

# dd-agent was previously just run as a service before being run under
# supervisor.
- name: Stop service based dd-agent
  service:
    name: datadog-agent
    state: stopped
    enabled: no

- name: Copy dd-agent supervisord config
  template:
    src=dd-agent-supervisord.conf.j2
    dest="{{ supervisord_programs_dir }}/dd-agent-supervisord.conf"
    mode=0644
  notify:
    - reread supervisord
    - restart dd-agent

- name: Create additional_checksd directory
  file:
    path: "{{ additional_checksd_dir }}"
    state: directory

- name: Copy dd-agent datadog config
  template:
    src=datadog.conf.j2
    dest="{{ ddagent_conf_path }}"
    mode=0644
  notify:
    - restart dd-agent
