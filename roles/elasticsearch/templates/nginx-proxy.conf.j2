############################## IMPORTANT ######################################
# Always run the following command to test the config before restarting
# $ nginx -t
################################ DO IT! #######################################

user {{ elasticsearch_nginx_proxy.nginx_worker_user }};

events {
    worker_connections  2048;
}

http {
  log_format   main '$host $remote_addr - $remote_user [$time_local]  $status ' '"$request" $body_bytes_sent "$http_referer" ' '"$http_user_agent" "$http_x_forwarded_for"';
  access_log /var/log/nginx/access.log main;
  error_log  /var/log/nginx/error.log;
  client_max_body_size 100M;

  upstream local_es {
    server {{ inventory_hostname }}:{{ elasticsearch_nginx_proxy.upstream_port }};
    keepalive 15;
  }

  server {
    listen {{ elasticsearch_nginx_proxy.listen_port }};

    auth_basic "Protected Elasticsearch";
    auth_basic_user_file {{ elasticsearch_nginx_proxy_auth.htpasswd_file }};

    location / {
      proxy_pass http://local_es;
      proxy_http_version 1.1;
      proxy_set_header Connection "Keep-Alive";
      proxy_set_header Proxy-Connection "Keep-Alive";
      proxy_connect_timeout       300;
      proxy_send_timeout          300;
      proxy_read_timeout          300;
      send_timeout                300;
    }

  }
  include /etc/nginx/sites-enabled/*;
}
